/*
I²C Write Sequence:
START ? [SLAVE_ADDR + W] ? ACK
        [MEM_ADDR]        ? ACK
        [DATA 1]          ? ACK
        [DATA 2]          ? ACK
        ...
        [DATA N]          ? ACK
STOP


I²C Read Sequence:
START ? [SLAVE_ADDR + W] ? ACK
        [MEM_ADDR]        ? ACK
REPEATED START
        [SLAVE_ADDR + R]  ? ACK
        [DATA 1]          ? ACK
        [DATA 2]          ? ACK
        ...
        [DATA N]          ? NACK
STOP
*/

#include <LPC214x.h>
#include "lcd.h"
#include "lcd_defines.h"
#include "delay.h"
#include "PLL.h"

#define SLAVE_ADDR_WRITE 0xA0  // EEPROM address + Write (LSB=0)
#define SLAVE_ADDR_READ  0xA1  // EEPROM address + Read  (LSB=1)

void I2C0_Init(void)
{
    PINSEL0 |= (1<<4) | (1<<6);    // P0.2=SCL0, P0.3=SDA0
    I2C0CONCLR = 0x6C;             // Clear AA, SI, STO, STA
    I2C0SCLH = 300;
    I2C0SCLL = 300;
    I2C0CONSET = 0x40;             // I2C Enable
}

void I2C0_Start(void)
{
    I2C0CONSET = 0x20;             // Set STA
    I2C0CONCLR = 0x08;             // Clear SI
    while (!(I2C0CONSET & 0x08));  // Wait for SI flag
}

void I2C0_Stop(void)
{
    I2C0CONSET = 0x10;             // Set STO
    I2C0CONCLR = 0x08;             // Clear SI
    while (I2C0CONSET & 0x10);     // Wait till STOP sent
}

void I2C0_Write(unsigned char data)
{
    I2C0DAT = data;
    I2C0CONCLR = 0x28;             // Clear STA, SI
    while (!(I2C0CONSET & 0x08));  // Wait for SI
}

unsigned char I2C0_Read_Byte_ACK(void)
{
    I2C0CONSET = 0x04;             // Set AA=1 ? Send ACK after receive
    I2C0CONCLR = 0x08;             // Clear SI
    while (!(I2C0CONSET & 0x08));  // Wait for SI
    return I2C0DAT;
}

unsigned char I2C0_Read_Byte_NACK(void)
{
    I2C0CONCLR = 0x04;             // Clear AA=0 ? Send NACK
    I2C0CONCLR = 0x08;             // Clear SI
    while (!(I2C0CONSET & 0x08));  // Wait for SI
    return I2C0DAT;
}

void EEPROM_Write_Bytes(unsigned char addr, unsigned char *data, unsigned int len)
{
    unsigned int i;
    I2C0_Start();
    I2C0_Write(SLAVE_ADDR_WRITE);  // Send slave + write
    I2C0_Write(addr);              // Memory address

    for (i = 0; i < len; i++)
        I2C0_Write(data[i]);       // Data bytes

    I2C0_Stop();
    delay_ms(10); // EEPROM internal write delay
}

void EEPROM_Read_Bytes(unsigned char addr, unsigned char *buf, unsigned int len)
{
    unsigned int i;

    // Step 1: Write memory address
    I2C0_Start();
    I2C0_Write(SLAVE_ADDR_WRITE);
    I2C0_Write(addr);

    // Step 2: Repeated start and switch to read mode
    I2C0_Start();
    I2C0_Write(SLAVE_ADDR_READ);

    // Step 3: Read bytes
    for (i = 0; i < len - 1; i++)
        buf[i] = I2C0_Read_Byte_ACK();   // ACK after each byte
    buf[len - 1] = I2C0_Read_Byte_NACK(); // NACK after last byte

    I2C0_Stop();
}

int main(void)
{
    unsigned char write_data[] = {'H', 'E', 'L', 'L', 'O'};
    unsigned char read_data[5];
    int i;

    initPLL();
    Init_LCD();
    I2C0_Init();

    CmdLCD(CLEAR_LCD);
    StrLCD("I2C Multi RW Demo");
    delay_s(1);

    EEPROM_Write_Bytes(0x00, write_data, 5);

    delay_ms(20);

    EEPROM_Read_Bytes(0x00, read_data, 5);

    CmdLCD(CLEAR_LCD);
    StrLCD("Read: ");
    for (i = 0; i < 5; i++)
				CharLCD(read_data[i]);

    while (1);
}
